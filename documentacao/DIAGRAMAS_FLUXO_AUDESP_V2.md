
# DIAGRAMAS DE FLUXO - AUDESP API SERVICE V2

## 1. FLUXO DE AUTENTICAรรO

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      USUรRIO FARร LOGIN                         โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
        โโโโโโโโโโโโโโโโโโโโโโ
        โ Insere Credenciais โ
        โ email + senha      โ
        โโโโโโโโโโฌโโโโโโโโโโโโ
                 โ
                 โผ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ AudespApiServiceV2.login()          โ
   โ Valida formato do email             โ
   โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ
            โผ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ AudespAuthServiceV2.login()          โ
   โ Codifica: email:senha em Base64      โ
   โ Header: x-authorization: Basic...    โ
   โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ
            โผ
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   โ RetryCircuitBreaker.executarComRetry()
   โ โโ POST /api/login                 โ
   โ โโ Retry atรฉ 3 vezes               โ
   โ โโ Timeout: 30s                    โ
   โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ
    โโโโโโโโโดโโโโโโโโโโโ
    โ                  โ
    โผ                  โผ
โโโโโโโโโโโ     โโโโโโโโโโโโโโโโ
โ 200 OK  โ     โ Erro (4xx/5xx)
โโโโโโฌโโโโโ     โโโโโโโโฌโโโโโโโโ
     โ                 โ
     โผ                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ
โ Armazena Token:      โ  โ AudespErrorHandler
โ โข sessionStorage     โ  โ Mapeia erro      โ
โ โข localStorage       โ  โ Mensagem amigรกvelโ
โ โข Expira em (JWT)    โ  โโโโโโโโฌโโโโโโโโโโโโ
โโโโโโฌโโโโโโโโโโโโโโโโโโ         โ
     โ                           โผ
     โผ                    โโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโโโโโโ  โ Registra na Log โ
โ Registra em Auditoria   โ AudespAuditLog
โ tipo: LOGIN          โ  โ timestamp       โ
โ usuรกrio, email, cpf  โ  โ status, erro    โ
โโโโโโฌโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโฌโโโโโโโโโ
     โ                            โ
     โผ                            โผ
  โ Sucesso                   โ Erro
  token retornado             mensagem ao usuรกrio
```

## 2. FLUXO DE ENVIO (FASE V)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Usuรกrio Preenche Formulรกrio Prestaรงรฃo    โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ AudespApiServiceV2.enviarPrestacaoContas โ
โ Fase5(dados)                             โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    Validar? โโโโโบโ AudespecValidatorService     โ
    (schema)      โ .validar()                   โ
                  โ โโ Campos obrigatรณrios       โ
                  โ โโ Formatos vรกlidos          โ
                  โ โโ Regras de negรณcio         โ
                  โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
                           โ
                    โโโโโโโโดโโโโโโโ
                    โ             โ
                    โผ             โผ
              โ Vรกlido      โ Invรกlido
                    โ             โ
                    โผ             โผ
                    โ      โโโโโโโโโโโโโโโโโโโโ
                    โ      โ Erro Validaรงรฃo   โ
                    โ      โ Mostra ao usuรกrioโ
                    โ      โ por campo        โ
                    โ      โโโโโโโโโโโโโโโโโโโโ
                    โ
                    โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ Prepara FormData:        โ
        โ โโ documentoJSON (blob)  โ
        โ โโ Content-Type JSON     โ
        โ โโ Headers auth          โ
        โโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ RetryCircuitBreaker      โ
        โ .executarComRetry()      โ
        โ โโ POST /f5/...          โ
        โ โโ Retry 3x              โ
        โ โโ Backoff exponencial   โ
        โ โโ Timeout 30s           โ
        โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
                 โ
         โโโโโโโโโดโโโโโโโโโโ
         โ                 โ
         โผ                 โผ
    โโโโโโโโโโโโ     โโโโโโโโโโโโโโ
    โ 200 OK   โ     โ Erro (4xx) โ
    โโโโโโฌโโโโโโ     โโโโโโโโฌโโโโโโ
         โ                  โ
         โผ                  โผ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ Parse Response JSON          โ
    โ โโ protocolo AUDESP          โ
    โ โโ status (Recebido)         โ
    โ โโ dataHora                  โ
    โ โโ erros (se houver)         โ
    โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ Registra em Auditoria        โ
    โ tipo: ENVIO                  โ
    โ protocolo, status, tempo     โ
    โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
    โ Protocolo para usuรกrio
    ๐ Guardado em auditoria
    โ Pronto para consulta
```

## 3. FLUXO DE CONSULTA DE PROTOCOLO

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Usuรกrio Informa Nรบmero de Protocolo  โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ AudespApiServiceV2.consultarProtocolo()
โ (numero, fase)                   โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ RetryCircuitBreaker              โ
โ .executarComRetry()              โ
โ โโ GET /f{4|5}/consulta/{numero} โ
โ โโ Retry 3x                      โ
โ โโ Timeout 30s                   โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
    โโโโโโดโโโโโโโโ
    โ            โ
    โผ            โผ
โโโโโโโโโโโ   โโโโโโโโโโโโโโ
โ 200 OK  โ   โ 404/Erro   โ
โโโโโโฌโโโโโ   โโโโโโโโฌโโโโโโ
     โ               โ
     โผ               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Parse Response              โ
โ โโ status: Recebido |       โ
โ โ           Armazenado |    โ
โ โ           Rejeitado       โ
โ โโ dataHora                 โ
โ โโ descricao                โ
โ โโ erros[] (se rejeitado)   โ
โ โโ historico[]              โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Registra em Auditoria       โ
โ tipo: CONSULTA              โ
โ protocolo, status, tempo    โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Exibir ao Usuรกrio:          โ
โ โโ Status atual             โ
โ โโ Histรณrico de mudanรงas    โ
โ โโ Erros (se houver)        โ
โ โโ Prรณximo passo            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 4. FLUXO DE RENOVAรรO DE TOKEN

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Requisiรงรฃo HTTP Sendo Preparada  โ
โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ AudespAuthServiceV2.obterTokenValido()
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
    โโโโโโโโโโโโโโโโโโ
    โ Token existe?  โ
    โโโโโโฌโโโโโโโโโฌโโโ
         โ Nรฃo    โ Sim
         โ        โ
         โผ        โผ
    โ Nulo   โโโโโโโโโโโโโโโโโโโ
             โ Token vรกlido?    โ
             โโโโโโฌโโโโโโโโโฌโโโโโ
                  โ Nรฃo    โ Sim
                  โ        โ
                  โผ        โผ
            โโโโโโโโโโโโ  โ Usar token
            โ Prรณximo? โ
            โ Expira   โ
            โ em < 5minโ
            โโโโฌโโโโโฌโโโ
               โ Simโ Nรฃo
               โ    โ
               โผ    โผ
        โโโโโโโโโโโโโโโโโโโโ
        โ Renovar Token?   โ
        โ POST /refresh    โ
        โ โโ Retry 1x      โ
        โ โโ Timeout 10s   โ
        โโโโโโฌโโโโโโโโโโโโโโ
             โ
        โโโโโโดโโโโโโโ
        โ           โ
        โผ           โผ
    โ Novo   โ Erro
    token    Logout
    salvo    Relogin
```

## 5. FLUXO DE TRATAMENTO DE ERRO

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Erro na Requisiรงรฃo HTTP    โ
โ (Response ou Exception)    โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ AudespErrorHandler.processar()   โ
โ Tipo: Response | Error | RespostaAPI
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
    โโโโโโดโโโโโโโโโโโโโโโ
    โ                   โ
    โผ                   โผ
โโโโโโโโโโโโ      โโโโโโโโโโโโโโโโ
โ Response โ      โ Error object โ
โโโโโโฌโโโโโโ      โโโโโโฌโโโโโโโโโโ
     โ                 โ
     โผ                 โผ
โโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโโโ
โ Mapear Status:   โ โ Verificar msg:   โ
โ 400 โ Validaรงรฃo  โ โ "timeout"        โ
โ 401 โ Autent.    โ โ "Network"        โ
โ 403 โ Autorizaรงรฃoโ โ "CORS"           โ
โ 413 โ Arquivo    โ โ etc              โ
โ 422 โ Schema     โ โ                  โ
โ 429 โ Rate limit โ โ                  โ
โ 5xx โ Servidor   โ โ                  โ
โโโโโโฌโโโโโโโโโโโโโโ โโโโโโฌโโโโโโโโโโโโโโ
     โ                    โ
     โโโโโโโโโโฌโโโโโโโโโโโโ
              โ
              โผ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ ErroMapeado              โ
    โ โโ codigo                โ
    โ โโ mensagem              โ
    โ โโ tipo                  โ
    โ โโ errosPorCampo[]       โ
    โ โโ dica                  โ
    โ โโ recuperavel           โ
    โ โโ statusCode            โ
    โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ Registra em Auditoria    โ
    โ tipo: ERRO               โ
    โ statusCode, mensagem     โ
    โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโ
         โ
    โโโโโโดโโโโโโโโโโโโโ
    โ                 โ
    โผ                 โผ
โโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโ
โ Recuperรกvel?     โ โ Exibir ao User:โ
โ                  โ โ โโ Mensagem    โ
โ โ Sim โ Retry   โ โ โโ Erros campo โ
โ โ Nรฃo โ Falhar  โ โ โโ Dica        โ
โ                  โ โ โโ Protocolo?  โ
โโโโโโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโโโ
```

## 6. FLUXO DE CIRCUIT BREAKER

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Requisiรงรฃo sendo executada  โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ CircuitBreaker.obterEstado()    โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
    โโโโโโดโโโโโโโโโโโโโโโโโโโ
    โ                       โ
    โผ                       โผ
โโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโ
โ FECHADO     โ        โ ABERTO       โ
โโโโโโโโโโโโโโโค        โโโโโโโโโโโโโโโโค
โ โ Executar โ        โ โ Bloquear   โ
โ requisiรงรฃo  โ        โ Nova tentat. โ
โโโโโโฌโโโโโโโโโ        โโโโโโโโโโโโโโโโ
     โ                       โ
     โผ                       โ
โโโโโโโโโโโโโโโ              โ
โ Sucesso?    โ              โ
โโโฌโโโโโโโโโฌโโโ              โ
  โ Sim    โ Nรฃo             โ
  โ        โ                 โ
  โผ        โผ                 โ
โ OK   Incrementar         โ
         tentativas         โ
         falhas             โ
         โ                  โ
         โผ                  โ
    โโโโโโโโโโโโโโโโ        โ
    โ Limit=5      โ        โ
    โ atingido?    โ        โ
    โโโโฌโโโโโโโโโฌโโโ        โ
       โ Sim    โ Nรฃo       โ
       โ        โโโโโโโโโโโโโ
       โ                   โโ
       โผ                   โผ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ CB: ABERTO               โ
    โ Auto-reset em 60s        โ
    โ Estado: MEIO_ABERTO      โ
    โ โโ Tenta 1 req           โ
    โ โโ Se OK โ FECHADO       โ
    โ    Se erro โ ABERTO      โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

**Estes fluxos cobrem todos os cenรกrios principais da integraรงรฃo AUDESP API V2**
